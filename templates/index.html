
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Super-Resolution Pipeline</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Cropper.js CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
      <!-- Favicon -->
    <link rel="icon" href="{{ url_for('static', filename='increase.ico') }}" type="image/x-icon">

  <style>
    .file-upload {
      display: none;
    }
    .file-upload-label {
      transition: all 0.3s ease;
    }
    .file-upload-label:hover {
      transform: translateY(-2px);
    }
    .result-card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .result-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    }
    .progress-container {
      display: none;
    }
    #imagePreviewContainer {
      display: none;
      margin-top: 20px;
    }
    #imagePreview {
      max-width: 100%;
      max-height: 400px;
    }
    .cropper-crop-box, .cropper-view-box {
      border: 2px solid red;
    }
    .cropper-line, .cropper-point {
      background-color: red;
    }
    .cropper-view-box {
      outline: 2px solid red;
      outline-color: rgba(255, 0, 0, 0.75);
    }
    .toggle-checkbox:checked {
      right: 0;
      border-color: #0ea5e9;
    }
    .toggle-checkbox:checked + .toggle-label {
      background-color: #0ea5e9;
    }
    .comparison-container {
      position: relative;
      width: 100%;
      height: 400px;
      overflow: hidden;
    }
    .comparison-img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      transform-origin: 0 0;
      transition: transform 0.3s ease;
    }
    .comparison-slider {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
      opacity: 0;
      cursor: ew-resize;
      z-index: 10;
    }
    .comparison-divider {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 50%;
      width: 2px;
      background-color: white;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      transform: translateX(-50%);
      z-index: 2;
    }
    .comparison-handle {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      border-radius: 50%;
      padding: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 3;
    }
    .zoom-controls {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 5;
      background: rgba(255,255,255,0.8);
      padding: 5px;
      border-radius: 5px;
    }
    .result-image-container {
      position: relative;
      overflow: hidden;
      width: 100%;
      height: 192px;
    }
    .result-image {
      position: absolute;
      transition: transform 0.3s ease;
      transform-origin: 0 0;
      width: 100%;
      height: auto;
    }
    .zoom-area {
      position: absolute;
      border: 2px dashed rgba(255,0,0,0.7);
      background: rgba(255,255,255,0.2);
      pointer-events: none;
      display: none;
    }
    .zoom-controls-global {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 100;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <header class="bg-gradient-to-r from-blue-700 to-blue-900 text-white shadow-lg">
    <div class="container mx-auto px-4 py-6">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold mb-2">
            <i class="fas fa-expand-alt mr-2"></i>AI Super-Resolution Pipeline
          </h1>
          <p class="text-blue-200">Enhance your images with our advanced AI technology</p>
        </div>
        <div class="mt-4 md:mt-0">
          <span class="inline-flex items-center px-3 py-1 rounded-full bg-blue-600 text-sm font-medium">
            <span class="w-2 h-2 mr-2 rounded-full bg-green-400 animate-pulse"></span>
            System Active
          </span>
        </div>
      </div>
    </div>
  </header>

  <!-- Main content -->
  <main class="container mx-auto px-4 py-8">
    <!-- Upload section -->
    <section class="max-w-3xl mx-auto bg-white rounded-xl shadow-md overflow-hidden p-6 mb-10">
      <div class="text-center mb-6">
        <h2 class="text-2xl font-semibold text-gray-800 mb-2">Upload your image</h2>
        <p class="text-gray-600">Get high-resolution versions of your low-quality images</p>
      </div>

      <form id="uploadForm" method="POST" enctype="multipart/form-data" class="space-y-4">
        <div class="flex flex-col items-center justify-center border-2 border-dashed border-blue-300 rounded-lg p-8 bg-blue-50">
          <i class="fas fa-cloud-upload-alt text-blue-500 text-4xl mb-4"></i>
          <label for="imageUpload" class="file-upload-label cursor-pointer bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-lg shadow">
            <i class="fas fa-folder-open mr-2"></i>Select an image
          </label>
          <input id="imageUpload" type="file" name="image" accept="image/*" required class="file-upload">
          <p id="fileName" class="mt-2 text-sm text-gray-500">No file selected</p>
          <p class="text-xs text-gray-400 mt-2">Supported formats: JPG, PNG (Max 5MB)</p>
        </div>

        <!-- Image preview -->
        <div id="imagePreviewContainer" class="mt-4">
          <h3 class="text-lg font-semibold mb-2">Processing options</h3>
          <div class="flex items-center mb-3">
            <label class="inline-flex items-center cursor-pointer">
              <input type="checkbox" id="enableCropToggle" class="sr-only peer">
              <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
              <span class="ml-3 text-sm font-medium text-gray-700">Define a specific area</span>
            </label>
          </div>

          <div id="cropSection" class="hidden">
            <p class="text-sm text-gray-600 mb-3">Position the red frame on the area to enhance</p>
            <div class="relative">
              <img id="imagePreview" src="#" alt="Image preview" class="rounded-lg shadow-sm">
            </div>
            <div class="mt-3 flex justify-between">
              <button type="button" id="resetCrop" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-redo mr-1"></i> Reset
              </button>
              <div class="text-sm text-gray-500">
                <span id="cropSizeInfo">No area selected</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Progress bar -->
        <div id="progressContainer" class="progress-container mt-4">
          <div class="flex justify-between mb-1">
            <span class="text-sm font-medium text-blue-700">Processing...</span>
            <span id="progressPercent" class="text-sm font-medium text-blue-700">0%</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2.5">
            <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
          </div>
        </div>

        <div class="text-center pt-4">
          <button type="submit" id="submitBtn" class="btn btn-primary btn-lg px-8 py-3 text-lg font-semibold shadow-lg hover:shadow-xl transition duration-300">
            <i class="fas fa-magic mr-2"></i>Enhance Resolution
          </button>
        </div>
      </form>
    </section>

    <!-- Results section -->
    {% if input_image %}
    <div class="zoom-controls-global">
      <button class="zoom-btn zoom-in p-2 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200">
        <i class="fas fa-search-plus"></i>
      </button>
      <button class="zoom-btn zoom-out p-2 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200">
        <i class="fas fa-search-minus"></i>
      </button>
      <button class="zoom-btn zoom-reset p-2 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200">
        <i class="fas fa-sync-alt"></i>
      </button>
    </div>

    <section class="bg-white rounded-xl shadow-md overflow-hidden p-6">
      <div class="mb-4 p-3 bg-gray-100 rounded-lg">
        <p class="text-sm text-gray-700">
          <i class="fas fa-info-circle mr-2"></i>
          {% if was_cropped %}
          Enhancement was applied only to the selected area
          {% else %}
          Enhancement was applied to the entire image
          {% endif %}
        </p>
      </div>

      <div class="text-center mb-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-2">Enhanced Results</h2>
        <p class="text-gray-600">Compare the different stages of our super-resolution pipeline</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Low resolution image -->
        <div class="result-card bg-gray-50 rounded-lg overflow-hidden border border-gray-200 p-4">
          <div class="text-center mb-3">
            <span class="inline-block bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full font-semibold">
              <i class="fas fa-compress-alt mr-1"></i>Low-Resolution
            </span>
          </div>
          <div class="result-image-container" id="container40">
            <img src="{{ url_for('uploaded_file', filename='lr.png') }}" alt="Low resolution"
                 class="result-image" id="image40" data-width="40" data-height="40">
            <div class="zoom-area" id="zoomArea40"></div>
          </div>
          <div class="text-center text-sm text-gray-500 mb-2">
            40×40 pixels
          </div>
          <a href="{{ url_for('uploaded_file', filename='lr.png') }}" download 
             class="w-full btn btn-outline-primary btn-sm flex items-center justify-center">
            <i class="fas fa-download mr-2"></i>Download
          </a>
        </div>

        <!-- ESPCN image -->
        <div class="result-card bg-gray-50 rounded-lg overflow-hidden border border-gray-200 p-4">
          <div class="text-center mb-3">
            <span class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-semibold">
              <i class="fas fa-expand-alt mr-1"></i>ESPCN
            </span>
          </div>
          <div class="result-image-container" id="container80">
            <img src="{{ url_for('uploaded_file', filename='sr80.png') }}" alt="SR 80"
                 class="result-image" id="image80" data-width="80" data-height="80">
            <div class="zoom-area" id="zoomArea80"></div>
          </div>
          <div class="text-center text-sm text-gray-500 mb-2">
            80×80 pixels (2×)
          </div>
          <a href="{{ url_for('uploaded_file', filename='sr80.png') }}" download 
             class="w-full btn btn-outline-primary btn-sm flex items-center justify-center">
            <i class="fas fa-download mr-2"></i>Download
          </a>
        </div>

        <!-- Diffusion image -->
        <div class="result-card bg-gray-50 rounded-lg overflow-hidden border border-gray-200 p-4">
          <div class="text-center mb-3">
            <span class="inline-block bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded-full font-semibold">
              <i class="fas fa-expand mr-1"></i>Diffusion
            </span>
          </div>
          <div class="result-image-container" id="container160">
            <img src="{{ url_for('uploaded_file', filename='sr160.png') }}" alt="SR 160"
                 class="result-image" id="image160" data-width="160" data-height="160">
            <div class="zoom-area" id="zoomArea160"></div>
          </div>
          <div class="text-center text-sm text-gray-500 mb-2">
            160×160 pixels (4×)
          </div>
          <a href="{{ url_for('uploaded_file', filename='sr160.png') }}" download 
             class="w-full btn btn-outline-primary btn-sm flex items-center justify-center">
            <i class="fas fa-download mr-2"></i>Download
          </a>
        </div>
        
        <!-- Original image -->
        <div class="result-card bg-gray-50 rounded-lg overflow-hidden border border-gray-200 p-4">
          <div class="text-center mb-3">
            <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full font-semibold">
              <i class="fas fa-image mr-1"></i>Original
            </span>
          </div>
          <div class="result-image-container" id="containerOrig">
            <img src="{{ url_for('uploaded_file', filename=filename) }}" alt="Original image"
                 class="result-image" id="imageOrig">
            <div class="zoom-area" id="zoomAreaOrig"></div>
          </div>
          <div class="text-center text-sm text-gray-500 mb-2">
            Original resolution
          </div>
        </div>
      </div>

      <!-- Image comparator -->
      <div class="mt-10">
        <h3 class="text-lg font-semibold text-center mb-4 text-gray-700">Compare original and enhanced</h3>
        <div class="max-w-2xl mx-auto bg-gray-100 rounded-lg p-4">
          <div class="comparison-container">
            <img id="originalCompImg" src="{{ url_for('uploaded_file', filename=filename) }}" 
                 class="comparison-img" style="z-index: 1;">
            <img id="enhancedCompImg" src="{{ url_for('uploaded_file', filename='sr160.png') }}" 
                 class="comparison-img" style="clip-path: polygon(0 0, 50% 0, 50% 100%, 0 100%); z-index: 2;">
            <input type="range" min="0" max="100" value="50" 
                   class="comparison-slider" id="comparisonSlider">
            <div class="comparison-divider"></div>
            <div class="comparison-handle">
              <i class="fas fa-arrows-alt-h text-blue-600"></i>
            </div>
            <div class="zoom-controls">
              <button class="zoom-btn zoom-in" title="Zoom in">
                <i class="fas fa-search-plus"></i>
              </button>
              <button class="zoom-btn zoom-out" title="Zoom out">
                <i class="fas fa-search-minus"></i>
              </button>
              <button class="zoom-btn zoom-reset" title="Reset">
                <i class="fas fa-sync-alt"></i>
              </button>
            </div>
          </div>
          <div class="flex justify-between mt-2 text-sm text-gray-600">
            <span>Original</span>
            <span>Enhanced (4×)</span>
          </div>
        </div>
      </div>
    </section>
    {% endif %}
  </main>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      let cropper;
      const enableCropToggle = document.getElementById('enableCropToggle');
      const cropSection = document.getElementById('cropSection');
      const fileInput = document.getElementById('imageUpload');
      const fileNameDisplay = document.getElementById('fileName');
      const imagePreviewContainer = document.getElementById('imagePreviewContainer');
      const imagePreview = document.getElementById('imagePreview');
      const resetCropBtn = document.getElementById('resetCrop');
      const cropSizeInfo = document.getElementById('cropSizeInfo');
      const form = document.getElementById('uploadForm');
      
      // Toggle to enable/disable cropping
      enableCropToggle.addEventListener('change', function() {
        if (this.checked) {
          cropSection.classList.remove('hidden');
          if (imagePreview.src !== '#') {
            initCropper();
          }
        } else {
          cropSection.classList.add('hidden');
          if (cropper) {
            cropper.destroy();
            cropper = null;
          }
        }
      });

      // Display uploaded file
      fileInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
          fileNameDisplay.textContent = this.files[0].name;
          
          const reader = new FileReader();
          reader.onload = function(e) {
            imagePreview.src = e.target.result;
            imagePreviewContainer.style.display = 'block';
            
            if (enableCropToggle.checked) {
              initCropper();
            }
          };
          reader.readAsDataURL(this.files[0]);
        }
      });

      // Initialize cropper
      function initCropper() {
        if (cropper) {
          cropper.destroy();
        }
        
        cropper = new Cropper(imagePreview, {
          aspectRatio: 1,
          viewMode: 1,
          autoCropArea: 0.8,
          responsive: true,
          movable: true,
          zoomable: true,
          rotatable: false,
          scalable: false,
          cropBoxMovable: true,
          cropBoxResizable: true,
          toggleDragModeOnDblclick: false,
          minCropBoxWidth: 50,
          minCropBoxHeight: 50,
          ready: function() {
            updateCropSizeInfo();
          },
          crop: function() {
            updateCropSizeInfo();
          }
        });
      }

      // Reset selection
      resetCropBtn.addEventListener('click', function() {
        if (cropper) {
          cropper.reset();
          updateCropSizeInfo();
        }
      });

      // Update size information
      function updateCropSizeInfo() {
        if (cropper) {
          const cropBoxData = cropper.getCropBoxData();
          cropSizeInfo.textContent = `Selected area: ${Math.round(cropBoxData.width)}×${Math.round(cropBoxData.height)} px`;
        } else {
          cropSizeInfo.textContent = 'No area selected';
        }
      }
      
      // Form submission
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (enableCropToggle.checked && cropper) {
          const canvas = cropper.getCroppedCanvas();
          const cropData = cropper.getData();
          
          let cropDataInput = document.createElement('input');
          cropDataInput.type = 'hidden';
          cropDataInput.name = 'cropData';
          cropDataInput.value = JSON.stringify(cropData);
          form.appendChild(cropDataInput);
          
          canvas.toBlob(function(blob) {
            const file = new File([blob], fileInput.files[0].name, {type: blob.type});
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
            
            submitForm();
          }, fileInput.files[0].type);
        } else {
          submitForm();
        }
      });

      function submitForm() {
        const submitBtn = document.getElementById('submitBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
        progressContainer.style.display = 'block';
        
        let progress = 0;
        const interval = setInterval(() => {
          progress += Math.random() * 10;
          if (progress >= 100) {
            progress = 100;
            clearInterval(interval);
            form.submit();
          }
          progressBar.style.width = progress + '%';
          progressPercent.textContent = Math.round(progress) + '%';
        }, 300);
      }

      // Unified zoom system for results
      function setupUnifiedZoom() {
    const images = {
        orig: document.getElementById('imageOrig'),
        img40: document.getElementById('image40'),
        img80: document.getElementById('image80'),
        img160: document.getElementById('image160'),
        compOrig: document.getElementById('originalCompImg'),
        compEnhanced: document.getElementById('enhancedCompImg')
    };

    const containers = {
        orig: document.getElementById('containerOrig'),
        img40: document.getElementById('container40'),
        img80: document.getElementById('container80'),
        img160: document.getElementById('container160'),
        comp: document.querySelector('.comparison-container')
    };

    const zoomAreas = {
        orig: document.getElementById('zoomAreaOrig'),
        img40: document.getElementById('zoomArea40'),
        img80: document.getElementById('zoomArea80'),
        img160: document.getElementById('zoomArea160')
    };

    // Store original dimensions
    const originalDimensions = {
        width: images.orig.naturalWidth,
        height: images.orig.naturalHeight
    };

    // Calculate scale factors for each image
    const scaleFactors = {
        img40: images.img40 ? originalDimensions.width / images.img40.naturalWidth : 1,
        img80: images.img80 ? originalDimensions.width / images.img80.naturalWidth : 1,
        img160: images.img160 ? originalDimensions.width / images.img160.naturalWidth : 1,
        compEnhanced: images.compEnhanced ? originalDimensions.width / images.compEnhanced.naturalWidth : 1
    };

    let currentZoom = 1;
    let zoomCenter = { x: 0, y: 0 };
    let isDragging = false;
    let startX, startY, startTranslateX = 0, startTranslateY = 0;

    function calculateRelativePosition(container, clientX, clientY) {
        const rect = container.getBoundingClientRect();
        return {
            x: clientX - rect.left,
            y: clientY - rect.top
        };
    }

    function applyZoomToAll(zoomLevel, centerX, centerY, sourceKey = 'orig') {
        currentZoom = zoomLevel;
        zoomCenter = { x: centerX, y: centerY };

        // For each image, calculate the appropriate transform
        Object.entries(images).forEach(([key, img]) => {
            if (!img) return;
            
            const container = containers[key];
            if (!container) return;
            
            // Calculate the scaling factor for this image relative to original
            let scaleFactor = 1;
            if (key === 'img40') scaleFactor = scaleFactors.img40;
            else if (key === 'img80') scaleFactor = scaleFactors.img80;
            else if (key === 'img160') scaleFactor = scaleFactors.img160;
            else if (key === 'compEnhanced') scaleFactor = scaleFactors.compEnhanced;
            
            // Calculate the effective zoom for this specific image
            const effectiveZoom = zoomLevel;
            
            // Calculate the center point in this image's coordinates
            let imgCenterX, imgCenterY;
            
            if (sourceKey === 'orig') {
                // Convert original container coordinates to this image's coordinates
                imgCenterX = centerX * (img.naturalWidth / originalDimensions.width) * (container.clientWidth / images.orig.clientWidth);
                imgCenterY = centerY * (img.naturalHeight / originalDimensions.height) * (container.clientHeight / images.orig.clientHeight);
            } else {
                // Convert from source image coordinates to this image's coordinates
                const sourceImg = images[sourceKey];
                const sourceScaleFactor = scaleFactors[sourceKey] || 1;
                
                // Convert to original image coordinates first
                const origX = centerX * (originalDimensions.width / (sourceImg.naturalWidth * sourceScaleFactor));
                const origY = centerY * (originalDimensions.height / (sourceImg.naturalHeight * sourceScaleFactor));
                
                // Then to this image's coordinates
                imgCenterX = origX * (img.naturalWidth / originalDimensions.width) * (container.clientWidth / images.orig.clientWidth);
                imgCenterY = origY * (img.naturalHeight / originalDimensions.height) * (container.clientHeight / images.orig.clientHeight);
            }
            
            // Calculate translation to keep the center point fixed
            const translateX = -imgCenterX * (effectiveZoom - 1);
            const translateY = -imgCenterY * (effectiveZoom - 1);
            
            // Apply the transform
            img.style.transform = `scale(${effectiveZoom}) translate(${translateX}px, ${translateY}px)`;
            
            // Update zoom area if it exists
            if (zoomAreas[key]) {
                if (zoomLevel > 1) {
                    const zoomArea = zoomAreas[key];
                    zoomArea.style.display = 'block';
                    zoomArea.style.left = `${imgCenterX}px`;
                    zoomArea.style.top = `${imgCenterY}px`;
                    zoomArea.style.width = `${container.clientWidth / effectiveZoom}px`;
                    zoomArea.style.height = `${container.clientHeight / effectiveZoom}px`;
                } else {
                    zoomAreas[key].style.display = 'none';
                }
            }
        });
    }

    // Wheel zoom handler
    function handleWheelZoom(e) {
        e.preventDefault();
        
        const container = e.currentTarget;
        const containerKey = Object.keys(containers).find(key => containers[key] === container);
        const pos = calculateRelativePosition(container, e.clientX, e.clientY);
        
        const delta = -e.deltaY;
        const zoomFactor = delta > 0 ? 1.1 : 0.9;
        const newZoom = Math.max(1, Math.min(5, currentZoom * zoomFactor));
        
        applyZoomToAll(newZoom, pos.x, pos.y, containerKey);
    }

    // Initialize wheel zoom for all containers
    Object.values(containers).forEach(container => {
        if (container) {
            container.addEventListener('wheel', handleWheelZoom);
        }
    });

    // Button controls
    document.querySelectorAll('.zoom-in').forEach(btn => {
        btn.addEventListener('click', function() {
            const container = containers.orig;
            const centerX = container.clientWidth / 2;
            const centerY = container.clientHeight / 2;
            applyZoomToAll(Math.min(5, currentZoom * 1.2), centerX, centerY);
        });
    });

    document.querySelectorAll('.zoom-out').forEach(btn => {
        btn.addEventListener('click', function() {
            const container = containers.orig;
            const centerX = container.clientWidth / 2;
            const centerY = container.clientHeight / 2;
            applyZoomToAll(Math.max(1, currentZoom / 1.2), centerX, centerY);
        });
    });

    document.querySelectorAll('.zoom-reset').forEach(btn => {
        btn.addEventListener('click', function() {
            applyZoomToAll(1, 0, 0);
        });
    });

    // Drag to pan functionality
    function startDrag(e) {
        if (currentZoom > 1) {
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            
            const transform = images.orig.style.transform.match(/translate\(([^,]+)px,\s*([^)]+)px\)/);
            startTranslateX = transform ? parseFloat(transform[1]) : 0;
            startTranslateY = transform ? parseFloat(transform[2]) : 0;
            
            e.currentTarget.style.cursor = 'grabbing';
            document.body.style.cursor = 'grabbing';
        }
    }

    function doDrag(e) {
        if (isDragging && currentZoom > 1) {
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            
            const newTranslateX = startTranslateX + dx;
            const newTranslateY = startTranslateY + dy;
            
            const container = containers.orig;
            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            
            // Calculate the new center based on translation
            const centerX = (-newTranslateX / (currentZoom - 1)) || containerWidth / 2;
            const centerY = (-newTranslateY / (currentZoom - 1)) || containerHeight / 2;
            
            applyZoomToAll(currentZoom, centerX, centerY);
        }
    }

    function endDrag() {
        isDragging = false;
        Object.values(containers).forEach(container => {
            if (container) container.style.cursor = '';
        });
        document.body.style.cursor = '';
    }

    // Initialize drag events
    Object.values(containers).forEach(container => {
        if (container) {
            container.addEventListener('mousedown', startDrag);
        }
    });

    document.addEventListener('mousemove', doDrag);
    document.addEventListener('mouseup', endDrag);
}
      // Image comparator
      function setupImageComparison() {
        const slider = document.getElementById('comparisonSlider');
        const originalImg = document.getElementById('originalCompImg');
        const enhancedImg = document.getElementById('enhancedCompImg');
        const divider = document.querySelector('.comparison-divider');
        const handle = document.querySelector('.comparison-handle');
        
        slider.addEventListener('input', function() {
          const value = this.value;
          enhancedImg.style.clipPath = `polygon(0 0, ${value}% 0, ${value}% 100%, 0 100%)`;
          divider.style.left = `${value}%`;
          handle.style.left = `${value}%`;
        });
      }

      // Initialization
      if (document.getElementById('image40')) {
        setupUnifiedZoom();
      }
      if (document.getElementById('comparisonSlider')) {
        setupImageComparison();
      }
    });
  </script>
</body>
</html>